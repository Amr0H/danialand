<!DOCTYPE html>
<html lang="en">
<head>
    <title>Employee Portal - Danialand</title>
    <link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css">
    <link rel="icon" href="images/cropped-logo-danialand.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
    --primary-color: #4a6fa5;
    --primary-dark: #2a4a7f;
    --primary-light: #3a5a8f;
    --success-color: #28a745;
    --danger-color: #dc3545;
    --warning-color: #ffc107;
    --info-color: #17a2b8;
    --light-gray: #f5f5f5;
    --dark-gray: #333;
    --matin-color: #FFD700;
    --soir-color: #4169E1;
    --repos-color: #FF6347;
    --maintenance-color: #000000;
    --recup-color: #32CD32;
    --conge-color: #9370DB;
    --jourferie-color: #FFA500;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #000;
    color: #333;
}

.container {
    max-width: 1400px;
    margin: 0 auto;
    background: white;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    border-radius: 20px;
}

.header-logo {
    text-align: center;
    margin-bottom: 25px;
}

.header-logo img {
    max-height: 100px;
    max-width: 100%;
}

/* Navigation Header */
.navigation-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    padding: 10px 20px;
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1000;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}
button {
            padding: 8px 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

.navigation-header img {
    height: 40px;
}

.nav-buttons {
    display: flex;
    gap: 10px;
}

.nav-buttons button {
    padding: 8px 15px;
    background-color: var(--primary-light);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.nav-buttons button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}

.nav-buttons button.logout {
    background-color: var(--danger-color);
}

.nav-buttons button.logout:hover {
    background-color: #c82333;
}

/* Controls Section */
.controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding: 15px;
    background-color: var(--light-gray);
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.week-navigation {
    display: flex;
    align-items: center;
    gap: 15px;
}

.nav-btn {
    width: 150px;
    padding: 10px 15px;
    background-color: var(--primary-light);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.nav-btn:hover,
button:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}

#weekDisplay {
    font-weight: 600;
    font-size: 16px;
    color: var(--dark-gray);
    min-width: 200px;
    text-align: center;
}

.action-buttons {
    display: flex;
    align-items: center;
    gap: 10px;
}

.action-btn {
    padding: 10px 15px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.action-btn:hover {
    background-color: var(--primary-dark);
    transform: translateY(-1px);
}


.export-btn {
    padding: 10px 15px;
    background-color: #555;
    color: white;
    border: none;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}

.export-btn:hover {
    background-color: #333;
    transform: translateY(-1px);
}

.export-btn:first-child {
    background-color: #e74c3c;
}

.export-btn:first-child:hover {
    background-color: #c0392b;
}

.export-btn:last-child {
    background-color: #2ecc71;
}

.export-btn:last-child:hover {
    background-color: #27ae60;
}

/* Table Styles */
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

th, td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
}

th {
    background-color: var(--primary-color);
    color: white;
    position: sticky;
    top: 0;
    font-weight: 600;
}

/* Shift Cell Styles */
td {
    position: relative;
    min-width: 100px;
    height: 40px;
    transition: all 0.2s;
}

td:hover {
    transform: scale(1.02);
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
    z-index: 1;
}

/* Shift Specific Styles */
.matin-shift {
    background-color: #fff49b;
    color: #333;
    font-weight: 600;
}

.soir-shift {
    background-color: #ffc107;
    color: white;
    font-weight: 600;
}

.repos-shift {
    background-color: #ff0000;
    color: white;
    font-weight: 600;
}

.maintenance-shift {
    background-color:#999999 ;
    color: white ;
    font-weight: 600;
}

.recup-shift {
    background-color: #92b6f0;
    color: white;
    font-weight: 600;
}

.conge-shift {
    background-color: #28a745;
    color: white;
    font-weight: 600;
}

.jourferie-shift {
    background-color: #005fe0;
    color: white;
    font-weight: 600;
}

/* Shift Indicators */
.shift-indicator {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: bold;
    opacity: 0.8;
    pointer-events: none;
}

/* Select Dropdowns */
select {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-size: 17px;
    background-color: rgba(255,255,255,0.2);
    border: 1px solid rgba(0,0,0,0.1);
    cursor: pointer;
    appearance: none;
    text-align: center;
    text-align-last: center;
    color: #000000;
}

select:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(255,255,255,0.3);
}

.readonly-select {
    background-color: #f5f5f5;
    cursor: not-allowed;
    opacity: 0.8;
}

/* Employee Name Styling */
.employee-name {
    font-weight: 600;
    padding: 10px;
    background-color: #f8f9fa;
    border-radius: 4px;
    white-space: nowrap;
}

.employee-name span {
    cursor: pointer;
    transition: color 0.2s;
}

.employee-name span:hover {
    color: var(--primary-dark);
}

/* Attendance Dots */
.attendance-dot {
    position: absolute;
    top: 2px;
    right: 2px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
}

.present {
    background-color: var(--success-color);
}

.absent {
    background-color: var(--danger-color);
}

/* Legend Styles */
.legend {
    margin-top: 30px;
    padding: 15px;
    background-color: #f2f2f2;
    border-radius: 5px;
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
}

.legend-item {
    display: flex;
    align-items: center;
    margin-right: 15px;
}

.color-box {
    width: 20px;
    height: 20px;
    margin-right: 8px;
    border: 1px solid #ddd;
    position: relative;
}

.color-box .shift-indicator {
    font-size: 10px;
    color: inherit;
}

/* Modal Styles */
.modal {
    display: none;
    position: fixed;
    z-index: 100;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.4);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 25px;
    border: 1px solid #888;
    width: 80%;
    max-width: 500px;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    position: relative;
}

.close {
    color: #aaa;
    position: absolute;
    right: 20px;
    top: 15px;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.form-group {
    margin-bottom: 20px;
}

label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
}

input[type="text"],
input[type="number"] {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-sizing: border-box;
    font-size: 16px;
}

/* Attendance Controls */
.attendance-controls {
    display: flex;
    gap: 5px;
    margin-top: 5px;
}

.attendance-btn {
    padding: 5px 10px;
    font-size: 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.attendance-btn.present {
    background-color: var(--success-color);
    color: white;
}

.attendance-btn.absent {
    background-color: var(--danger-color);
    color: white;
}

.attendance-btn.active {
    transform: scale(1.05);
    box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
}

/* Modal Actions */
.modal-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 25px;
}

.modal-actions button {
    flex: 1;
    margin: 0 5px;
    padding: 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
}

.modal-actions button.delete {
    background-color: var(--danger-color);
    color: white;
}

.modal-actions button.update {
    background-color: var(--primary-color);
    color: white;
}

.modal-actions button.delete:hover {
    background-color: #c82333;
}
.modal-actions button.update:hover {
    background-color: var(--primary-dark);
}

/* Toast Notifications */
.toast {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    background-color: var(--primary-color);
    color: white;
    border-radius: 4px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    z-index: 1000;
    animation: slideIn 0.3s, fadeOut 0.5s 2.5s;
    animation-fill-mode: forwards;
}

@keyframes slideIn {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

@keyframes fadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
}

/* Print Styles */
@media print {
    .navigation-header,
    .controls,
    .legend {
        display: none !important;
    }
    
    body {
        background: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    .container {
                box-shadow: none;
                padding: 0;
                margin-top: 0 !important;
            }
   
    
    table {
        page-break-inside: auto;
    }
    
    tr {
        page-break-inside: avoid;
        page-break-after: auto;
    }
}

/* Responsive Styles */
@media (max-width: 1200px) {
    .controls {
        flex-direction: column;
        gap: 15px;
    }
    
    .week-navigation {
        width: 100%;
        justify-content: center;
    }
    
    .action-buttons {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
    }
}

@media (max-width: 768px) {
    .container {
        padding: 15px;
    }
    
    .nav-btn {
        width: 120px;
        padding: 8px 10px;
        font-size: 14px;
    }
    
    .action-btn, .export-btn {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    th, td {
        padding: 8px 5px;
        font-size: 12px;
    }
    
    .shift-indicator {
        font-size: 10px;
    }
    
    select {
        font-size: 12px;
        padding: 5px;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="header-logo">
            <img src="images/logo-svg-dania-01.png" alt="DANIA LAND Planning System">
        </div> 
        
        <div class="controls">
    <div class="week-navigation">
        <button id="prevWeek" class="nav-btn"><i class="fas fa-arrow-left"></i> Semaine Précédente</button>
        <span id="weekDisplay"></span>
        <button id="nextWeek" class="nav-btn">Semaine Prochaine <i class="fas fa-arrow-right"></i></button>
    </div>
    <div class="action-buttons">
        <button id="addEmployee" class="action-btn"><i class="fal fa-plus"></i> Ajouter Un Employé</button>
        <button id="printBtn" class="action-btn"><i class="fas fa-print"></i> Imprimer</button>
        <button id="saveBtn" class="action-btn"><i class="fas fa-save"></i> Enregistrer</button>
    </div>
</div>
        
        <table id="scheduleTable">
            <thead>
                <tr id="headerRow">
                    <th style="width: 200px;">Employee</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        
        <div class="legend">
            <h3 style="width: 100%; margin-top: 0;">Legend:</h3>
            <div class="legend-item">
                <div class="color-box" style="background-color: var(--success-color);"></div>
                <span>Present</span>
            </div>
            <div class="legend-item">
                <div class="color-box" style="background-color: var(--danger-color);"></div>
                <span>Absent</span>
            </div>
            <div class="legend-item">
                <div class="color-box matin-shift"></div>
                <span>Matin (08:30 - 16:30)</span>
            </div>
            <div class="legend-item">
                <div class="color-box soir-shift"></div>
                <span>Soir (16:30 - 23:30)</span>
            </div>
            <div class="legend-item">
                <div class="color-box maintenance-shift"></div>
                <span>Maintenance</span>
            </div>
            <div class="legend-item">
                <div class="color-box repos-shift"></div>
                <span>Repos</span>
            </div>
            <div class="legend-item">
                <div class="color-box recup-shift"></div>
                <span>Recup</span>
            </div>
            <div class="legend-item">
                <div class="color-box conge-shift"></div>
                <span>Conge</span>
            </div>
            <div class="legend-item">
            <div class="color-box jourferie-shift"></div>
                <span>JourFerie</span>
            </div>
        </div>
    </div>
    
    <div id="employeeModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Add New Employee</h2>
            <div class="form-group">
                <label for="employeeName">Name:</label>
                <input type="text" id="employeeName" placeholder="Enter employee name">
            </div>
            <button id="submitEmployee">Add to Schedule</button>
        </div>
    </div>

    <div id="editEmployeeModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Edit Employee</h2>
        <div class="form-group">
            <label for="editEmployeeName">Name:</label>
            <input type="text" id="editEmployeeName">
        </div>
        <div class="modal-actions">
            <button id="updateEmployee" class="update">Update</button>
            <button id="deleteEmployee" class="delete">Delete</button>
        </div>
    </div>
</div>

    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Attendance for <span id="attendanceEmployee"></span></h2>
            <h3 id="attendanceDate"></h3>
            <div class="form-group">
                <label>Status:</label>
                <div class="attendance-controls">
                    <button class="attendance-btn present" data-status="present">Present</button>
                    <button class="attendance-btn absent" data-status="absent">Absent</button>
                    <button class="attendance-btn" data-status="none">Clear</button>
                </div>
            </div>
            <div class="form-group">
                <label for="attendanceNotes">Notes:</label>
                <input type="text" id="attendanceNotes" placeholder="Optional notes">
            </div>
            <div class="form-group">
                <label for="overtimeHours">Overtime Hours:</label>
                <input type="number" id="overtimeHours" min="0" placeholder="0">
            </div>
            <button id="saveAttendance">Save Attendance</button>
        </div>
    </div>

    <script>
        // Check if user is logged in
if (sessionStorage.getItem('loggedIn') !== 'true') {
    window.location.href = 'login.html';
}

// Initialize Firebase
const firebaseConfig = {
    apiKey: "AIzaSyBAxMIvXpnL-qSqWxF29c44mjXBMKfL6mM",
    authDomain: "danialand-employee-portal.firebaseapp.com",
    projectId: "danialand-employee-portal",
    storageBucket: "danialand-employee-portal.firebasestorage.app",
    messagingSenderId: "595567528213",
    appId: "1:595567528213:web:74a807c312cbc63c50c11c"
};

// Check if Firebase app is already initialized
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();

// Add auth state listener
auth.onAuthStateChanged((user) => {
    if (!user) {
        sessionStorage.clear();
        window.location.href = 'login.html';
    }
});

// Add navigation header
document.addEventListener('DOMContentLoaded', function() {
    // Create header
    const header = document.createElement('div');
    header.className = 'navigation-header';
    header.style.position = 'fixed';
    header.style.top = '0';
    header.style.left = '0';
    header.style.right = '0';
    header.style.padding = '10px 20px';
    header.style.color = 'white';
    header.style.display = 'flex';
    header.style.justifyContent = 'space-between';
    header.style.alignItems = 'center';
    header.style.zIndex = '1000';
    
    // Add logo
    const logo = document.createElement('div');
    logo.innerHTML = '<img src="images/beach resort.png" alt="Logo" style="height: 40px;">';
    header.appendChild(logo);
    
    // Add navigation buttons
    const navButtons = document.createElement('div');
    navButtons.style.display = 'flex';
    navButtons.style.gap = '10px';
    
    const menuBtn = document.createElement('button');
    menuBtn.innerHTML = '<i class="fas fa-home"></i> Menu';
    menuBtn.style.padding = '8px 15px';
    menuBtn.style.backgroundColor = 'var(--primary-color)';
    menuBtn.style.color = 'white';
    menuBtn.style.borderRadius = '4px';
    menuBtn.style.cursor = 'pointer';
    menuBtn.addEventListener('click', function() {
        window.location.href = 'menu.html';
    });
    
    const attendanceBtn = document.createElement('button');
    attendanceBtn.innerHTML = '<i class="fas fa-user-check"></i>Pointage';
    attendanceBtn.style.padding = '8px 15px';
    attendanceBtn.style.backgroundColor = 'var(--primary-color)';
    attendanceBtn.style.color = 'white';
    attendanceBtn.style.borderRadius = '4px';
    attendanceBtn.style.cursor = 'pointer';
    attendanceBtn.addEventListener('click', function() {
        window.location.href = 'yn5.html';
    });
    
    const logoutBtn = document.createElement('button');
    logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
    logoutBtn.style.padding = '8px 15px';
    logoutBtn.style.backgroundColor = '#dc3545';
    logoutBtn.style.color = 'white';
    logoutBtn.style.border = 'none';
    logoutBtn.style.borderRadius = '4px';
    logoutBtn.style.cursor = 'pointer';
    logoutBtn.addEventListener('click', function() {
        auth.signOut().then(() => {
            sessionStorage.clear();
            window.location.href = 'login.html';
        });
    });
    
    navButtons.appendChild(menuBtn);
    navButtons.appendChild(attendanceBtn);
    navButtons.appendChild(logoutBtn);
    header.appendChild(navButtons);
    
    document.body.insertBefore(header, document.body.firstChild);
    
    // Add padding to container to account for fixed header
    document.querySelector('.container').style.marginTop = '60px';
    
    // Disable certain features for non-admin users
    if (sessionStorage.getItem('userRole') !== 'admin') {
        document.getElementById('addEmployee').style.display = 'none';
        document.getElementById('saveBtn').style.display = 'none';
        
        // Make all selects read-only
        document.querySelectorAll('select').forEach(select => {
            select.disabled = true;
        });
    }
});
        let currentWeek = 0;
        let currentEditingEmployee = null;
        let currentAttendanceData = { employee: null, dayIndex: null };
        
        let scheduleData = {
            employees: [
                
            ],
            shifts: ["Matin", "Soir", "Repos", "Maintenance", "Recup", "Conge", "Jourferie"],
            weeks: {},
            attendance: {}
        };
        
        const scheduleTable = document.getElementById('scheduleTable');
        const headerRow = document.getElementById('headerRow');
        const tbody = scheduleTable.querySelector('tbody');
        const weekDisplay = document.getElementById('weekDisplay');
        const prevWeekBtn = document.getElementById('prevWeek');
        const nextWeekBtn = document.getElementById('nextWeek');
        const addEmployeeBtn = document.getElementById('addEmployee');
        const printBtn = document.getElementById('printBtn');
        const saveBtn = document.getElementById('saveBtn');
        
        const employeeModal = document.getElementById('employeeModal');
        const editEmployeeModal = document.getElementById('editEmployeeModal');
        const attendanceModal = document.getElementById('attendanceModal');
        
        const closeButtons = document.querySelectorAll('.close');
        const submitEmployeeBtn = document.getElementById('submitEmployee');
        const employeeNameInput = document.getElementById('employeeName');
        const editEmployeeNameInput = document.getElementById('editEmployeeName');
        const updateEmployeeBtn = document.getElementById('updateEmployee');
        const deleteEmployeeBtn = document.getElementById('deleteEmployee');
        const attendanceEmployeeSpan = document.getElementById('attendanceEmployee');
        const attendanceDateSpan = document.getElementById('attendanceDate');
        const attendanceNotesInput = document.getElementById('attendanceNotes');
        const overtimeHoursInput = document.getElementById('overtimeHours');
        const saveAttendanceBtn = document.getElementById('saveAttendance');
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function init() {
            loadData();
            renderWeek();
            setupEventListeners();
        }
        
       async function loadData() {
    try {
        // Load schedule data
        const monthDoc = await db.collection('schedules').doc('current').get();
        if (monthDoc.exists) {
            scheduleData = monthDoc.data();
        } else {
            await initializeScheduleData();
        }
        
        // Load employees and merge with schedule data
        const employeesSnapshot = await db.collection('employees').where('active', '==', true).get();
        const activeEmployees = employeesSnapshot.docs.map(doc => doc.data().name);
        
        // Add any employees that exist in Firestore but not in local data
        activeEmployees.forEach(employee => {
            if (!scheduleData.employees.includes(employee)) {
                scheduleData.employees.push(employee);
                
                // Initialize for all weeks
                Object.keys(scheduleData.weeks).forEach(week => {
                    if (!scheduleData.weeks[week][employee]) {
                        scheduleData.weeks[week][employee] = Array(7).fill("Matin");
                    }
                });
                
                Object.keys(scheduleData.attendance).forEach(week => {
                    if (!scheduleData.attendance[week][employee]) {
                        scheduleData.attendance[week][employee] = Array(7).fill(null);
                    }
                });
            }
        });
        
        // Remove any employees that don't exist in Firestore
        scheduleData.employees = scheduleData.employees.filter(employee => 
            activeEmployees.includes(employee)
        );
        
        renderWeek();
    } catch (error) {
        console.error("Error loading data:", error);
        showToast("Error loading schedule data");
    }
}

        
        async function saveData() {
    try {
        await db.collection('schedules').doc('current').set(scheduleData, { merge: true });
        showToast('Schedule saved successfully!');
    } catch (error) {
        console.error("Error saving data:", error);
        showToast("Error saving schedule", "error");
    }
}
async function initializeScheduleData() {
    scheduleData = {
        employees: [],
        shifts: ["Matin", "Soir", "Repos", "Maintenance", "Recup", "Conge", "Jourferie"],
        weeks: {},
        attendance: {}
    };
    
    // Save default employees to Firestore
    const batch = db.batch();
    scheduleData.employees.forEach(employee => {
        const empRef = db.collection('employees').doc(employee.replace(/\s+/g, '_'));
        batch.set(empRef, { name: employee, active: true });
    });
    await batch.commit();
    
    await db.collection('schedules').doc('current').set(scheduleData);
}

// Real-time listener for schedule updates
function setupRealtimeListeners() {
    // For xxx.html (schedule page)
    db.collection('schedules').doc('current')
        .onSnapshot((doc) => {
            if (doc.exists) {
                scheduleData = doc.data();
                renderWeek();
            }
        });
        
    
    // For employee list updates
    db.collection('employees').where('active', '==', true)
        .onSnapshot((snapshot) => {
            employees = snapshot.docs.map(doc => doc.data().name);
            renderTable(); // or renderWeek() depending on the page
        });
}
        
        function initializeWeek(weekIndex) {
            if (!scheduleData.weeks[weekIndex]) {
                scheduleData.weeks[weekIndex] = {};
                scheduleData.employees.forEach(employee => {
                    scheduleData.weeks[weekIndex][employee] = Array(7).fill("Matin");
                });
            }
            
            if (!scheduleData.attendance[weekIndex]) {
                scheduleData.attendance[weekIndex] = {};
                scheduleData.employees.forEach(employee => {
                    scheduleData.attendance[weekIndex][employee] = Array(7).fill(null);
                });
            }
        }
        function renderWeek() {
    initializeWeek(currentWeek);
    
    // Clear existing table content
    headerRow.innerHTML = '<th style="width: 200px;">Employee</th>';
    tbody.innerHTML = '';
    
    const weekData = scheduleData.weeks[currentWeek];
    const attendanceData = scheduleData.attendance[currentWeek];
    
    // Calculate week dates (keep this part)
    const today = new Date();
    const monday = new Date(today);
    monday.setDate(today.getDate() - today.getDay() + 1 + (currentWeek * 7));
    
    const weekDates = [];
    for (let i = 0; i < 7; i++) {
        const date = new Date(monday);
        date.setDate(monday.getDate() + i);
        weekDates.push(date);
        
        const th = document.createElement('th');
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        th.textContent = `${day}/${month}/${year}`;
        headerRow.appendChild(th);
    }
    
    // Update week display (keep this part)
    const weekStart = `${String(weekDates[0].getDate()).padStart(2, '0')}/${String(weekDates[0].getMonth() + 1).padStart(2, '0')}/${weekDates[0].getFullYear()}`;
    const weekEnd = `${String(weekDates[6].getDate()).padStart(2, '0')}/${String(weekDates[6].getMonth() + 1).padStart(2, '0')}/${weekDates[6].getFullYear()}`;
    weekDisplay.textContent = `Semaine: ${weekStart} - ${weekEnd}`;
    
    // Render employee rows (updated version)
    scheduleData.employees.forEach(employee => {
        const row = document.createElement('tr');
        
        // Employee name cell (updated with security check)
        const nameCell = document.createElement('td');
        nameCell.className = 'employee-name';
        
        const nameSpan = document.createElement('span');
        nameSpan.textContent = employee;
        
        // Only allow editing for admins
        if (sessionStorage.getItem('userRole') === 'admin') {
            nameSpan.title = "Click to edit";
            nameSpan.addEventListener('click', () => openEditModal(employee));
            nameSpan.style.cursor = 'pointer';
        } else {
            nameSpan.style.cursor = 'default';
        }
        
        nameCell.appendChild(nameSpan);
        row.appendChild(nameCell);
        
        // Create cells for each day (updated with new shift styling)
        for (let i = 0; i < 7; i++) {
            const cell = document.createElement('td');
            cell.className = 'attendance-cell';
            
            const select = document.createElement('select');
            
            // Add readonly class for non-admins
            if (sessionStorage.getItem('userRole') !== 'admin') {
                select.classList.add('readonly-select');
                select.disabled = true;
            }
            
            // Populate shift options (keep this part)
            scheduleData.shifts.forEach(shift => {
                const option = document.createElement('option');
                option.value = shift;
                option.textContent = shift;
                select.appendChild(option);
            });
            
            select.value = weekData[employee][i];
            
            // Add shift class and indicator (new implementation)
            const shiftClass = `${select.value.toLowerCase().replace(' ', '-')}-shift`;
            cell.classList.add(shiftClass);
            
            const shiftIndicator = document.createElement('div');
            shiftIndicator.className = 'shift-indicator';
            cell.appendChild(shiftIndicator);
            
            // Shift change handler (updated)
            select.addEventListener('change', () => {
                // Remove all shift classes
                cell.className = 'attendance-cell';
                
                weekData[employee][i] = select.value;
                
                // Add new shift class
                const newShiftClass = `${select.value.toLowerCase().replace(' ', '-')}-shift`;
                cell.classList.add(newShiftClass);
                
                // Update shift indicator
            });
            
            // Attendance dot (keep this part)
            const attendanceStatus = attendanceData[employee][i];
            if (attendanceStatus) {
                const dot = document.createElement('div');
                dot.className = `attendance-dot ${attendanceStatus.status || 'present'}`;
                cell.appendChild(dot);
                
                if (attendanceStatus.notes) {
                    cell.title = attendanceStatus.notes;
                }
            }
            
            // Cell click handler (keep this part)
            cell.addEventListener('click', (e) => {
                if (e.target.tagName !== 'SELECT') {
                    openAttendanceModal(employee, i, weekDates[i]);
                }
            });
            
            cell.appendChild(select);
            row.appendChild(cell);
        }
        
        tbody.appendChild(row);
    });
}


// Helper function for shift abbreviations (new)

        
        

        function openEditModal(employee) {
            currentEditingEmployee = employee;
            editEmployeeNameInput.value = employee;
            editEmployeeModal.style.display = 'block';
        }
        
        function openAttendanceModal(employee, dayIndex, date) {
            currentAttendanceData = { employee, dayIndex };
            attendanceEmployeeSpan.textContent = employee;
            attendanceDateSpan.textContent = date.toLocaleDateString('en-US', { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
            
            const attendanceStatus = scheduleData.attendance[currentWeek][employee][dayIndex];
            if (attendanceStatus) {
                attendanceNotesInput.value = attendanceStatus.notes || '';
                overtimeHoursInput.value = attendanceStatus.overtimeHours || '0';
            } else {
                attendanceNotesInput.value = '';
                overtimeHoursInput.value = '0';
            }
            
            attendanceModal.style.display = 'block';
        }
        
        function saveAttendance() {
            const { employee, dayIndex } = currentAttendanceData;
            const status = document.querySelector('.attendance-btn.active')?.dataset.status || 'present';
            
            if (!scheduleData.attendance[currentWeek]) {
                scheduleData.attendance[currentWeek] = {};
            }
            if (!scheduleData.attendance[currentWeek][employee]) {
                scheduleData.attendance[currentWeek][employee] = Array(7).fill(null);
            }
            
            scheduleData.attendance[currentWeek][employee][dayIndex] = {
                status,
                notes: attendanceNotesInput.value.trim(),
                overtimeHours: parseInt(overtimeHoursInput.value) || 0
            };
            
            renderWeek();
            attendanceModal.style.display = 'none';
            showToast('Attendance saved successfully!');
        }
        
        function deleteEmployee() {
            if (confirm(`Are you sure you want to delete "${currentEditingEmployee}"? This cannot be undone.`)) {
                const index = scheduleData.employees.indexOf(currentEditingEmployee);
                if (index !== -1) {
                    scheduleData.employees.splice(index, 1);
                    
                    Object.keys(scheduleData.weeks).forEach(week => {
                        delete scheduleData.weeks[week][currentEditingEmployee];
                    });
                    
                    Object.keys(scheduleData.attendance).forEach(week => {
                        delete scheduleData.attendance[week][currentEditingEmployee];
                    });
                    
                    saveData();
                    editEmployeeModal.style.display = 'none';
                    renderWeek();
                    showToast('Employee deleted successfully!');
                }
            }
        }
        
        

        
        
        function setupEventListeners() {     
            prevWeekBtn.addEventListener('click', () => {
                currentWeek--;
                renderWeek();
            });
            
            nextWeekBtn.addEventListener('click', () => {
                currentWeek++;
                renderWeek();
            });
            
            addEmployeeBtn.addEventListener('click', () => {
    employeeNameInput.value = '';
    employeeModal.style.display = 'block';
});

submitEmployeeBtn.addEventListener('click', async () => {
    const newEmployee = employeeNameInput.value.trim();
    if (newEmployee && !scheduleData.employees.includes(newEmployee)) {
        try {
            // Add to local data first
            scheduleData.employees.push(newEmployee);
            
            // Initialize for all existing weeks
            Object.keys(scheduleData.weeks).forEach(week => {
                scheduleData.weeks[week][newEmployee] = Array(7).fill("Matin");
            });
            
            Object.keys(scheduleData.attendance).forEach(week => {
                scheduleData.attendance[week][newEmployee] = Array(7).fill(null);
            });
            
            // Add to Firestore
            await db.collection('employees').doc(newEmployee.replace(/\s+/g, '_')).set({
                name: newEmployee,
                active: true
            });
            
            // Update the schedule data in Firestore
            await db.collection('schedules').doc('current').set(scheduleData, { merge: true });
            
            employeeNameInput.value = '';
            employeeModal.style.display = 'none';
            
            renderWeek();
            showToast('Employee added successfully!');
        } catch (error) {
            console.error("Error adding employee:", error);
            showToast('Error adding employee');
            // Rollback local changes if Firestore update fails
            const index = scheduleData.employees.indexOf(newEmployee);
            if (index !== -1) {
                scheduleData.employees.splice(index, 1);
                Object.keys(scheduleData.weeks).forEach(week => {
                    delete scheduleData.weeks[week][newEmployee];
                });
                Object.keys(scheduleData.attendance).forEach(week => {
                    delete scheduleData.attendance[week][newEmployee];
                });
            }
        }
    } else if (scheduleData.employees.includes(newEmployee)) {
        showToast('This employee already exists!');
    }
});
            
            updateEmployeeBtn.addEventListener('click', async () => {
    const newName = editEmployeeNameInput.value.trim();
    if (newName && newName !== currentEditingEmployee) {
        try {
            // Update local data first
            const index = scheduleData.employees.indexOf(currentEditingEmployee);
            if (index !== -1) {
                scheduleData.employees[index] = newName;
                
                // Update weeks data
                Object.keys(scheduleData.weeks).forEach(week => {
                    scheduleData.weeks[week][newName] = scheduleData.weeks[week][currentEditingEmployee];
                    delete scheduleData.weeks[week][currentEditingEmployee];
                });
                
                // Update attendance data
                Object.keys(scheduleData.attendance).forEach(week => {
                    scheduleData.attendance[week][newName] = scheduleData.attendance[week][currentEditingEmployee];
                    delete scheduleData.attendance[week][currentEditingEmployee];
                });
                
                // Update Firestore
                const batch = db.batch();
                
                // Delete old employee doc
                batch.delete(db.collection('employees').doc(currentEditingEmployee.replace(/\s+/g, '_')));
                
                // Create new employee doc
                batch.set(db.collection('employees').doc(newName.replace(/\s+/g, '_')), {
                    name: newName,
                    active: true
                });
                
                // Update schedule data
                batch.set(db.collection('schedules').doc('current'), scheduleData, { merge: true });
                
                await batch.commit();
                
                editEmployeeModal.style.display = 'none';
                renderWeek();
                showToast('Employee updated successfully!');
            }
        } catch (error) {
            console.error("Error updating employee:", error);
            showToast('Error updating employee');
            // Rollback local changes
            if (index !== -1) {
                scheduleData.employees[index] = currentEditingEmployee;
                Object.keys(scheduleData.weeks).forEach(week => {
                    scheduleData.weeks[week][currentEditingEmployee] = scheduleData.weeks[week][newName];
                    delete scheduleData.weeks[week][newName];
                });
                Object.keys(scheduleData.attendance).forEach(week => {
                    scheduleData.attendance[week][currentEditingEmployee] = scheduleData.attendance[week][newName];
                    delete scheduleData.attendance[week][newName];
                });
            }
        }
    }
});
            
            deleteEmployeeBtn.addEventListener('click', async () => {
    if (confirm(`Are you sure you want to delete "${currentEditingEmployee}"? This cannot be undone.`)) {
        try {
            const index = scheduleData.employees.indexOf(currentEditingEmployee);
            if (index !== -1) {
                // Update local data first
                scheduleData.employees.splice(index, 1);
                
                Object.keys(scheduleData.weeks).forEach(week => {
                    delete scheduleData.weeks[week][currentEditingEmployee];
                });
                
                Object.keys(scheduleData.attendance).forEach(week => {
                    delete scheduleData.attendance[week][currentEditingEmployee];
                });
                
                // Update Firestore
                const batch = db.batch();
                
                // Mark employee as inactive (soft delete)
                batch.update(db.collection('employees').doc(currentEditingEmployee.replace(/\s+/g, '_')), {
                    active: false
                });
                
                // Update schedule data
                batch.set(db.collection('schedules').doc('current'), scheduleData, { merge: true });
                
                await batch.commit();
                
                editEmployeeModal.style.display = 'none';
                renderWeek();
                showToast('Employee deleted successfully!');
            }
        } catch (error) {
            console.error("Error deleting employee:", error);
            showToast('Error deleting employee');
            // Rollback local changes
            scheduleData.employees.splice(index, 0, currentEditingEmployee);
            Object.keys(scheduleData.weeks).forEach(week => {
                scheduleData.weeks[week][currentEditingEmployee] = Array(7).fill("Matin");
            });
            Object.keys(scheduleData.attendance).forEach(week => {
                scheduleData.attendance[week][currentEditingEmployee] = Array(7).fill(null);
            });
        }
    }
});
            
            document.querySelectorAll('.attendance-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.attendance-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
            
            saveAttendanceBtn.addEventListener('click', saveAttendance);
            
            printBtn.addEventListener('click', () => {
                window.print();
            });
            
            saveBtn.addEventListener('click', saveData);
            
            
            
            closeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    employeeModal.style.display = 'none';
                    editEmployeeModal.style.display = 'none';
                    attendanceModal.style.display = 'none';
                });
            });
            
            
            window.addEventListener('click', (event) => {
                if (event.target === employeeModal) {
                    employeeModal.style.display = 'none';
                }
                if (event.target === editEmployeeModal) {
                    editEmployeeModal.style.display = 'none';
                }
                if (event.target === attendanceModal) {
                    attendanceModal.style.display = 'none';
                }
            });
        }
        
        init();
    </script>
</body>
</html>